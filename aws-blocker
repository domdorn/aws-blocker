#/bin/bash

# Create the AWS iptables chain if it doesn't exist
#iptables -n --list AWS >/dev/null 2>&1 \
#    || (iptables -N AWS && iptables -I INPUT 1 -j AWS)

LIST_NAME=blacklist_aws

ipset create --exist ${LIST_NAME} hash:net hashsize 1024


# Get list of IP ranges
#
# First we use curl to grab the official list of ranges from Amazon. The -s
# prevents extraneous output from curl, and the -L makes it follow redirects.
#
# The ranges are passed to jq, a JSON parser. The -r makes jq output raw data
# without quotes. We only need the list of prefixes, so we discard everything
# else.
RANGES=$(curl -s -L https://ip-ranges.amazonaws.com/ip-ranges.json \
    | jq -r '.prefixes[].ip_prefix')


ipset flush ${LIST_NAME}

# Loop through the ranges, adding each to the list
for line in $RANGES; do
	ipset -A ${LIST_NAME} $line -exist
done

 
